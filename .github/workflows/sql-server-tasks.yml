name: Run SQL Server Projects Analysis, Build, Profile, Publish DACPACs & BACPACs

on:
  workflow_dispatch:
  push:
    paths:
    - '**.sql'
    - '**.sqlproj'
    - '**.publish.xml'
    - '**.dacpac'
    - '**.bacpac'
    - './.github/workflows/sql-server-tasks.yml'

jobs:
  set-git-environment:
    runs-on: ubuntu-latest
    name: Set Git environment

    steps:
      - name: Set Git environment variables
        run: |
          echo "GIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "GIT_BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Use Git environment variables
        run: |
          echo "GIT_SHA=${GIT_SHA}"
          echo "GIT_BRANCH=${GIT_BRANCH}"

  sql-analysis-windows:
    name: Analysis SQL Server projects on Windows Server
    runs-on: windows-latest
    needs: [set-git-environment]

    steps:
      - uses: actions/checkout@v4
      - name: Run SQL Analysis with CLI
        run: .\config\make.ps1 -Task Init, SqlAnalysis
        shell: powershell

  sql-analysis-linux:
    name: Analysis SQL Server projects on Linux
    runs-on: ubuntu-latest
    needs: [set-git-environment]

    steps:
      - uses: actions/checkout@v4
      - name: Run SQL Analysis with CLI
        run: ./config/make.ps1 -Task Init, SqlAnalysis
        shell: pwsh

  sql-build-windows:
    name: Build SQL Server projects on Windows Server
    runs-on: windows-latest
    needs: [sql-analysis-windows]

    steps:
      - uses: actions/checkout@v4
      - name: Run dotnet build with CLI
        run: .\config\make.ps1 -Task Init, DotnetClean, DotnetSolution, ProjectByModule, DotnetRestore, DotnetBuild
        shell: powershell

  sql-build-linux:
    name: Build SQL Server projects on Linux
    runs-on: ubuntu-latest
    needs: [sql-analysis-linux]

    steps:
      - uses: actions/checkout@v4
      - name: Run dotnet build with CLI
        run: ./config/make.ps1 -Task Init, DotnetClean, DotnetSolution, ProjectByModule, DotnetRestore, DotnetBuild
        shell: pwsh

  sql-dacpac-windows:
    name: Create SQL Server DACPACs on Windows Server
    runs-on: windows-latest
    needs: [sql-build-windows]

    steps:
      - uses: actions/checkout@v4
      - name: Run dotnet artifact creation with CLI
        run: .\config\make.ps1 -Task Init, ProjectByModule, SqlProfile, SqlTools, SqlDacpac
        shell: powershell
      - name: Upload DACPACs
        uses: actions/upload-artifact@v4
        with:
          name: dacpac-windows
          path: '**/*.dacpac'

  sql-dacpac-linux:
    name: Create SQL Server DACPACs on Linux
    runs-on: ubuntu-latest
    needs: [sql-build-linux]

    steps:
      - uses: actions/checkout@v4
      - name: Run dotnet artifact creation with CLI
        run: ./config/make.ps1 -Task Init, ProjectByModule, SqlProfile, SqlTools, SqlDacpac
        shell: pwsh
      - name: Upload DACPACs
        uses: actions/upload-artifact@v4
        with:
          name: dacpac-linux
          path: '**/*.dacpac'

#  sql-profile-test-windows:
#    name: Test SQL Server connection using repository secrets on Windows Server
#    runs-on: windows-latest
#    needs: [sql-dacpac-windows]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Install SqlServer module
#        run: |
#          Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
#          Import-Module SqlServer
#        shell: powershell
#      - name: Test SQL Server connection using repository secrets
#        run: |
#          $serverName = ${{ secrets.SQLSERVERNAME }}
#          $database = ${{ secrets.SQLDATABASE }}
#          $user = ${{ secrets.SQLUSER }}
#          $password = ${{ secrets.SQLPASSWORD }}
#          Invoke-Sqlcmd -ServerInstance $serverName -Database $database -Username $user -Password $password -Query "SELECT GETDATE() AS CurrentDateTime, @@VERSION AS ServerVersion" | Out-String
#        shell: powershell

#  sql-profile-test-linux:
#    name: Test SQL Server connection using repository secrets on Linux
#    runs-on: ubuntu-latest
#    needs: [sql-dacpac-linux]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Install SqlServer module
#        run: |
#          Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
#          Import-Module SqlServer
#        shell: pwsh
#      - name: Test SQL Server connection using repository secrets
#        run: |
#          $serverName = "${{ secrets.SQLSERVERNAME }}"
#          $database = "${{ secrets.SQLDATABASE }}"
#          $user = "${{ secrets.SQLUSER }}"
#          $password = "${{ secrets.SQLPASSWORD }}"
#          Invoke-Sqlcmd -ServerInstance $serverName -Database $database -Username $user -Password $password -Query "SELECT GETDATE() AS CurrentDateTime, @@VERSION AS ServerVersion" | Out-String
#        shell: pwsh

#  sql-publish-windows:
#    name: Publish SQL Server artifacts from Windows Server
#    runs-on: windows-latest
#    needs: [sql-profile-test-windows]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Run dotnet publish with CLI
#        run: .\config\make.ps1 -Task Init, ProjectByModule, SqlProfile, SqlTools, SqlDacpac, SqlPublish
#        shell: powershell

#  sql-publish-linux:
#    name: Publish SQL Server artifacts from Linux
#    runs-on: ubuntu-latest
#    needs: [sql-profile-test-linux]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Run dotnet publish with CLI
#        run: ./config/make.ps1 -Task Init, ProjectByModule, SqlProfile, SqlTools, SqlDacpac, SqlPublish
#        shell: pwsh

#  sql-bacpac-windows:
#    name: Create SQL Server BACPACs on Windows Server
#    runs-on: windows-latest
#    needs: [sql-publish-windows]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Run dotnet BACPAC creation with CLI
#        run: .\config\make.ps1 -Task Init, SqlBacpac
#        shell: powershell
#      - name: Upload BACPACs
#        uses: actions/upload-artifact@v4
#        with:
#          name: bacpac-windows
#          path: '**/*.bacpac'
#
#  sql-bacpac-linux:
#    name: Create SQL Server BACPACs on Linux
#    runs-on: ubuntu-latest
#    needs: [sql-publish-linux]
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Run dotnet BACPAC creation with CLI
#        run: ./config/make.ps1 -Task Init, SqlBacpac
#        shell: pwsh
#      - name: Upload BACPACs
#        uses: actions/upload-artifact@v4
#        with:
#          name: bacpac-linux
#          path: '**/*.bacpac'